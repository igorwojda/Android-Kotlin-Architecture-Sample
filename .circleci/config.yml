version: 2.1

jobs:
    update_dependency_cache:
        working_directory: ~/data

        docker:
            - image: circleci/android:api-29

        environment:
            _JAVA_OPTS: -Xmx2g

        steps:
            - checkout
            - restore_cache:
                  key: gradle-{{ .Branch }}
            - run:
                  name: Download Dependencies
                  command: ./gradlew androidDependencies
            - save_cache:
                  paths:
                      - ~/.gradle
                  key: gradle-{{ .Branch }}

    ktlint:
        working_directory: ~/data

        docker:
            - image: circleci/android:api-29

        environment:
            _JAVA_OPTS: -Xmx2g

        steps:
            - checkout
            - restore_cache:
                  key: gradle-{{ .Branch }}
            - run: ./gradlew ktlintCheck
    detekt:
        working_directory: ~/data

        docker:
            - image: circleci/android:api-29

        environment:
            _JAVA_OPTS: -Xmx2g

        steps:
            - checkout
            - restore_cache:
                  key: gradle-{{ .Branch }}
            - run: ./gradlew detekt

    lint:
        working_directory: ~/data

        docker:
            - image: circleci/android:api-29

        environment:
            _JAVA_OPTS: -Xmx2g

        steps:
            - checkout
            - restore_cache:
                  key: gradle-{{ .Branch }}
            - run: ./gradlew lint --no-parallel

    unit_test:
        working_directory: ~/data

        docker:
            - image: circleci/android:api-29

        environment:
            _JAVA_OPTS: -Xmx2g

        steps:
            - checkout
            - restore_cache:
                  key: gradle-{{ .Branch }}
            - run: ./gradlew testDebugUnitTest

    build_app:
        working_directory: ~/data

        docker:
            - image: circleci/android:api-29

        environment:
            _JAVA_OPTS: -Xmx2g

        steps:
            - checkout
            - restore_cache:
                  key: gradle-{{ .Branch }}
            - run: ./gradlew :app:bundleDebug
workflows:
    version: 2
    verify_code:
        jobs:
            - update_dependency_cache
            - lint:
                  requires:
                      - update_dependency_cache
            - detekt:
                  requires:
                      - update_dependency_cache
            - ktlint:
                  requires:
                      - update_dependency_cache
            - unit_test:
                  requires:
                      - update_dependency_cache
            - build_app:
                  requires:
                      - lint
                      - detekt
                      - ktlint
                      - unit_test
